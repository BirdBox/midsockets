<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>..&#x2F;..&#x2F;midsockets&#x2F;lib&#x2F;promises&#x2F;deferred.js - midsockets</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http:&#x2F;&#x2F;masonblier.github.com&#x2F;midsockets&#x2F;logo.png" title="midsockets"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.3</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/App.html">App</a></li>
            
                <li><a href="..&#x2F;classes/Deferred.html">Deferred</a></li>
            
                <li><a href="..&#x2F;classes/DeferredRequest.html">DeferredRequest</a></li>
            
                <li><a href="..&#x2F;classes/DeferredResponse.html">DeferredResponse</a></li>
            
                <li><a href="..&#x2F;classes/Events.html">Events</a></li>
            
                <li><a href="..&#x2F;classes/Inheritance.html">Inheritance</a></li>
            
                <li><a href="..&#x2F;classes/Middleware.html">Middleware</a></li>
            
                <li><a href="..&#x2F;classes/MiddlewarePrototype.html">MiddlewarePrototype</a></li>
            
                <li><a href="..&#x2F;classes/RequestClient.html">RequestClient</a></li>
            
                <li><a href="..&#x2F;classes/RequestGhost.html">RequestGhost</a></li>
            
                <li><a href="..&#x2F;classes/Router.html">Router</a></li>
            
                <li><a href="..&#x2F;classes/SockjsClient.html">SockjsClient</a></li>
            
                <li><a href="..&#x2F;classes/SockjsServer.html">SockjsServer</a></li>
            
                <li><a href="..&#x2F;classes/Utils.html">Utils</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/midsockets.html">midsockets</a></li>
            
                <li><a href="..&#x2F;modules/Promises.html">Promises</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: ..&#x2F;..&#x2F;midsockets&#x2F;lib&#x2F;promises&#x2F;deferred.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;**
  @module midsockets
  @submodule Promises
**&#x2F;

&#x2F;**
  An promises&#x2F;a compatable promise implementation
  based on https:&#x2F;&#x2F;github.com&#x2F;ForbesLindesay&#x2F;promises-a

  @class Deferred
  @constructor
**&#x2F;

function Deferred() {
  this.resolved = false;
  this.fulfilled = false;
  this.fulfill = fulfill.bind(this);
  this.reject = reject.bind(this);
  this.val = undefined;
  this.waiting = [];
  this.running = false;
  this.promise = {
    then: then.bind(this), 
    valueOf: valueOf.bind(this), 
    done: done.bind(this)
  };
}

module.exports = Deferred;

Deferred.prototype.resolve = function resolve(success, value) {
  if (this.resolved) return;
  if (success &amp;&amp; value &amp;&amp; typeof value.then === &#x27;function&#x27;) {
    value.then(this.fulfill.bind(this), this.reject.bind(this))
  } else {
    this.resolved = true
    this.fulfilled = success
    this.val = value
    __next.bind(this)()
  }
};

function fulfill(val) {
  this.resolve(true, val)
}
function reject(err) {
  this.resolve(false, err)
}

function valueOf() {
  return this.fulfilled ? this.val : this.promise;
}

function __next(){
  if (this.waiting.length) {
    this.running = true
    this.waiting.shift()()
  } else {
    this.running = false
  }
};

function then(cb, eb) {
  var _this = this;
  var def = new Deferred();
  var next = __next.bind(this);
  var handler = function() {
    var callback = _this.fulfilled ? cb : eb;
    if (typeof callback === &#x27;function&#x27;) {
      setTimeout(function(){
        var result;
        try {
          result = callback(_this.val);
        } catch (ex) {
          def.reject(ex);
          next();
        }
        def.fulfill(result);
        next();
      }, 0);
    } else if (_this.fulfilled) {
      def.fulfill(_this.val);
      next();
    } else {
      def.reject(_this.val);
      next();
    }
  }
  this.waiting.push(handler);
  if (_this.resolved &amp;&amp; !_this.running) {
    next()
  }
  return def.promise
};

function done(cb, eb) {
  var p = this.promise; &#x2F;&#x2F; support &#x27;hot&#x27; promises
  if (cb || eb) {
    p = p.then(cb, eb)
  }
  p.then(null, function (reason) {
    setTimeout(function () {
      throw reason
    }, 0);
  })
};
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
