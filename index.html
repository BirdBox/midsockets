<!DOCTYPE html>
<html>
  <head>
    <title>midsockets :: documentation</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script src="jquery-1.9.1.js"></script>
    <script src="highlight.js"></script>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div id="wrapper">
      <div id="page-title">
        <h1>midsockets</h1>
        <hr>
      </div>

      <p>midsockets is a wrapper around sockjs to provide middleware, routing, and a promise-like
        request api.</p>

      <h2>creating a chat app:</h2>

      <h3>server</h3>

      <p>Create a router which will respond to incoming routes. Mount this router on midsockets.</p>
      <pre>
        <code>
  var api = new midsockets.Router();
  midsockets("/midsockets").mount("/chat",api);
        </code>
      </pre>

      <p>You will need to attach it to an HTTP server.</p>
      <pre>
        <code>
  var server = http.createServer(app);
  sockApp.listen(server);
        </code>
      </pre>

      <p>Next, create an endpoint which allows sending a message to the rest of the chatters. Here, we loop through all the listener functions we created and call them.</p>
      <pre>
        <code>
  api.on("/chat/send",function(req,res){
    _listeners.forEach(function(listener){
      listener({body: req.data.body});
    });
    res.resolve();
  });
        </code>
      </pre>

      <p>To create an endpoint which provides pushing data to the client after time, we can postpone resolving the request. An unresolved-request will stay open, and events can be emitted on it until it is closed.</p>
      <pre>
        <code>
  var _listeners = [];
  api.on("/chat/subscription",function(req,res){
    var subscription = function(obj){
      res.emit("message",obj);
    };
    _listeners.push(subscription);
  });
        </code>
      </pre>

      <h3>client</h3>

      <p>Initialize midsockets with the midsockets() function, and get a RequestClient to use the promises api.</p>

      <pre>
        <code>
  window.Api = midsockets("/midsockets").requestClient()
        </code>
      </pre>

      <p>You can create a child requester at a given route if you with to decouple the absolute routes from the implementation.</p>

      <pre>
        <code>
  var chat = Api.requester("/chat");
        </code>
      </pre>

      <p>A get request returns a promise, the two most important functions of which are done() and on(). To get our chat subscription, we would .get() it from the RequestClient and listen to events emited on it until it is resolved.</p>

      <pre>
        <code>
  chat.get("/subscription").on("message",function(obj){
    console.log("someone said: "+obj.body);
  }).done(function(){
    console.log("chat has closed");
  });
        </code>
      </pre>

      <p>Since sending a message requires data to be attached, use the RequestClient#post(route,data) method.</p>

      <pre>
        <code>
  function sendMessage(text){
    chat.post("/send",{body:text}).done(function(){
      console.log("message "+text+" has been sent");
    });
  };
        </code>
      </pre>
    </div>
  </body>
</html>